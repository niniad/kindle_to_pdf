# 実装計画: Kindle Capture Desktop App

## 目的
Windowsデスクトップ上で動作するKindleアプリ（またはブラウザ）の表示内容を、UI操作で指定した範囲で自動撮影し、NotebookLMに最適化されたPDFを生成する。
Chrome拡張機能ではなく、Python製のスタンドアロンGUIアプリケーションとして実装する。

## User Review Required
- **キャプチャ範囲の指定**:
    - **プリセット**: A4, A5, B6などの標準アスペクト比を選択可能にします。
    - **自由選択**: マウスドラッグで任意の矩形領域を選択可能にします。
- **ウィンドウのアクティブ化**: 開始ボタン押下後、カウントダウン（5秒）中にユーザーがKindleウィンドウを手動でアクティブにすることを前提とします。
- **NotebookLM制限**: PDF作成時、200MBの制限を超えないように自動分割します。

## Proposed Changes

### Tech Stack
- **UI Framework**: `customtkinter` (モダンなダークモードUIを実現)
- **Automation**: `pyautogui` (キー送信), `pywin32` (ウィンドウ制御推奨)
- **Capture**: `mss` (高速スクリーンショット), `opencv-python` (画像比較・差分検知)
- **PDF**: `img2pdf` (ロスレス画像結合)

### File Structure
- `app.py`: アプリケーションのエントリーポイント。
- `gui_app.py`: `customtkinter` を用いたメインウィンドウの実装。
- `capture_logic.py`: スクリーンショット撮影、ページめくり、画像比較のコアロジック。
- `pdf_writer.py`: 画像群をPDFに変換する処理。
- `requirements.txt`: 依存ライブラリの定義。

### Detailed Features

#### 1. UI Design (gui_app.py)
- **Inputs**:
    - ファイル名 (Entry): Book Title
    - ページ送り方向 (OptionMenu): "左→右 (横書き)", "右→左 (縦書き)"
    - キャプチャアスペクト比 (OptionMenu): "自由選択", "A4 (1:1.41)", "A5 (1:1.41)", "B6 (1:1.41)", "Kindle Paperwhite (3:4)" など
    - 待機時間 (Entry): デフォルト 1500 (1.5秒)
- **Action Buttons**:
    - **「撮影範囲を選択」**: 
        - オーバーレイを表示。
        - プリセット選択時: 固定比率の枠を表示し、移動/リサイズのみ許可。
        - 自由選択時: 任意の矩形をドラッグで指定。
    - **「最後・停止まで自動撮影」**: 
        - 押下後、5秒カウントダウン。
    - **「停止」**: ループを中断。
    - **「PDFダウンロード」**: 撮影した一時画像をPDFとして保存。

#### 2. Capture Loop (capture_logic.py)
1.  **Wait**: 5秒待機。
2.  **Focus**: ユーザーが手動でKindleをアクティブにする前提。
3.  **Loop**:
    - 指定範囲のスクリーンショット取得・保存。
    - **画像比較**: 前回の画像と比較。
        - **終了判定**: 数回連続で「変化なし」と判定された場合、終了シークエンスへ。
    - **重複削除**: 終了判定に使われた「最後の重複画像」は保存リストから削除する。
    - **Page Turn**: `pyautogui.press('right')` or `'left'`.
    - **Sleep**: 指定ms待機。

#### 3. NotebookLM Optimization
NotebookLMやLLMでの認識精度を最大化するための仕様:
- **1ページ単位**: 見開き（2ページ）ではなく、**1ページずつ（シングルカラム）**での撮影を推奨し、実装もそれを前提とします。
    - 理由: LLMのOCRは左上から右下へ読むため、マルチカラム（見開き）だと左ページの1行目→右ページの1行目と誤読するリスクがあるため。
- **フォント**: Kindle側での設定は、ゴシック体（サンセリフ）などの太めで明瞭なフォント、可能な限り大きな文字サイズ設定を推奨（UIに推奨設定として記載）。

#### 4. PDF Generation (pdf_writer.py)
- 保存された画像を `img2pdf` でPDF化。
- 出力ファイル名: `{入力されたタイトル}_{著者}_{連番}.pdf`
- サイズチェック: 200MB制限を超えないよう、ファイルサイズを監視して分割。

## Verification Plan
1.  **UIテスト**: アスペクト比選択が機能し、オーバーレイの挙動（固定比率/自由）が正しいか。
2.  **キャプチャテスト**: 
    - 自動停止後、最後の数枚に重複画像が含まれていないか確認。
3.  **LLMテスト**: 生成されたPDFをNotebookLMにアップロードし、テキストとして正しく認識されるか確認。
